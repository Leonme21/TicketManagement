@page "/tickets/{Id:int}"
@attribute [Authorize]
@inject ITicketApiClient TicketApiClient
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider
@using TicketManagement.Domain.Enums

<PageTitle>Ticket #@Id</PageTitle>

<div class="container-fluid py-5 px-4 px-lg-5">
    @if (_isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-emerald" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3 text-slate-500">Cargando detalles del ticket...</p>
        </div>
    }
    else if (_errorMessage != null)
    {
        <div class="alert alert-danger border-0 rounded-3 d-flex align-items-center gap-2 mb-4">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span>@_errorMessage</span>
        </div>
        <a href="/tickets" class="btn btn-emerald">
            <i class="bi bi-arrow-left me-2"></i> Volver a Tickets
        </a>
    }
    else if (_ticket != null)
    {
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb small">
                        <li class="breadcrumb-item">
                            <a href="/tickets" class="text-emerald text-decoration-none">Tickets</a>
                        </li>
                        <li class="breadcrumb-item active text-slate-500">Ticket #@Id</li>
                    </ol>
                </nav>
                <h2 class="mb-3 fw-bold text-slate-800">@_ticket.Title</h2>
                <div class="d-flex gap-2 flex-wrap">
                    <span class="badge rounded-pill @GetStatusBadgeClass(_ticket.Status) fs-6">
                        @GetStatusLabel(_ticket.Status)
                    </span>
                    <span class="badge rounded-pill @GetPriorityBadgeClass(_ticket.Priority) fs-6">
                        @GetPriorityLabel(_ticket.Priority)
                    </span>
                    <span class="badge rounded-pill bg-slate-100 text-slate-600 fs-6">
                        @_ticket.CategoryName
                    </span>
                </div>
            </div>
            <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                <AuthorizeView Roles="Admin,Agent">
                    @if (_ticket.Status != TicketStatus.Closed && _ticket.Status != TicketStatus.Resolved)
                    {
                        <button class="btn btn-emerald" @onclick="ShowCloseModal">
                            <i class="bi bi-check-circle me-1"></i> Cerrar Ticket
                        </button>
                    }
                </AuthorizeView>
                <AuthorizeView Roles="Admin">
                    <button class="btn btn-outline-danger ms-2" @onclick="ShowDeleteModal">
                        <i class="bi bi-trash me-1"></i> Eliminar
                    </button>
                </AuthorizeView>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(_successMessage))
        {
            <div class="alert alert-success border-0 rounded-3 alert-dismissible fade show d-flex align-items-center gap-2">
                <i class="bi bi-check-circle-fill"></i>
                <span>@_successMessage</span>
                <button type="button" class="btn-close" @onclick="() => _successMessage = null"></button>
            </div>
        }

        <div class="row g-4">
            <!-- Columna principal -->
            <div class="col-lg-8">
                <!-- Descripción -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white border-bottom py-3 px-4">
                        <h5 class="mb-0 fw-semibold text-slate-800">Descripción</h5>
                    </div>
                    <div class="card-body p-4">
                        <p class="white-space-pre-line text-slate-600 mb-0">@_ticket.Description</p>
                    </div>
                </div>

                <!-- Comentarios -->
                <div class="card shadow-sm border-0">
                    <div class="card-header bg-white border-bottom py-3 px-4">
                        <div class="d-flex align-items-center gap-2">
                            <i class="bi bi-chat-dots text-emerald"></i>
                            <h5 class="mb-0 fw-semibold text-slate-800">Comentarios (@_ticket.Comments.Count)</h5>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        @if (_ticket.Comments.Any())
                        {
                            <div class="comments-list">
                                @foreach (var comment in _ticket.Comments.OrderBy(c => c.CreatedAt))
                                {
                                    <div class="comment-item mb-3 p-3 rounded-3 bg-slate-50">
                                        <div class="d-flex justify-content-between mb-2">
                                            <div>
                                                <span class="fw-semibold text-slate-800">@comment.AuthorName</span>
                                                <span class="text-slate-400 small ms-2">@comment.AuthorEmail</span>
                                            </div>
                                            <small class="text-slate-400">
                                                @comment.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                                            </small>
                                        </div>
                                        <p class="mb-0 white-space-pre-line text-slate-600">@comment.Content</p>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-slate-400 mb-0">No hay comentarios aún.</p>
                        }

                        <!-- Agregar comentario -->
                        <hr class="my-4" />
                        <h6 class="mb-3 fw-semibold text-slate-700">Agregar comentario</h6>
                        <EditForm Model="@_commentRequest" OnValidSubmit="@HandleAddComment">
                            <DataAnnotationsValidator />
                            <div class="mb-3">
                                <InputTextArea class="form-control border-slate-200" rows="3"
                                               @bind-Value="_commentRequest.Content"
                                               placeholder="Escribe tu comentario aquí..." />
                                <ValidationMessage For="@(() => _commentRequest.Content)" class="text-danger small mt-1" />
                            </div>
                            <button type="submit" class="btn btn-emerald" disabled="@_isSubmittingComment">
                                @if (_isSubmittingComment)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                    <span>Enviando...</span>
                                }
                                else
                                {
                                    <i class="bi bi-send me-2"></i>
                                    <span>Enviar Comentario</span>
                                }
                            </button>
                        </EditForm>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Información -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white border-bottom py-3 px-4">
                        <h6 class="mb-0 fw-semibold text-slate-800">Información del Ticket</h6>
                    </div>
                    <div class="card-body p-4">
                        <div class="mb-4">
                            <small class="text-slate-400 text-uppercase" style="font-size: 0.7rem; letter-spacing: 0.5px;">Creado por</small>
                            <p class="mb-0 fw-semibold text-slate-800">@_ticket.CreatorName</p>
                            <small class="text-slate-500">@_ticket.CreatorEmail</small>
                        </div>

                        <div class="mb-4">
                            <small class="text-slate-400 text-uppercase" style="font-size: 0.7rem; letter-spacing: 0.5px;">Fecha de creación</small>
                            <p class="mb-0 text-slate-700">@_ticket.CreatedAt.ToString("dd/MM/yyyy HH:mm")</p>
                        </div>

                        @if (_ticket.UpdatedAt.HasValue)
                        {
                            <div class="mb-4">
                                <small class="text-slate-400 text-uppercase" style="font-size: 0.7rem; letter-spacing: 0.5px;">Última actualización</small>
                                <p class="mb-0 text-slate-700">@_ticket.UpdatedAt.Value.ToString("dd/MM/yyyy HH:mm")</p>
                            </div>
                        }

                        <div class="mb-4">
                            <small class="text-slate-400 text-uppercase" style="font-size: 0.7rem; letter-spacing: 0.5px;">Asignado a</small>
                            @if (_ticket.AssignedToId.HasValue)
                            {
                                <p class="mb-0 fw-semibold text-slate-800">@_ticket.AssignedToName</p>
                                <small class="text-slate-500">@_ticket.AssignedToEmail</small>
                            }
                            else
                            {
                                <p class="mb-0 text-slate-400">Sin asignar</p>
                            }
                        </div>

                        <div class="mb-0">
                            <small class="text-slate-400 text-uppercase" style="font-size: 0.7rem; letter-spacing: 0.5px;">Archivos adjuntos</small>
                            <p class="mb-0 text-slate-700">@_ticket.Attachments.Count archivos</p>
                        </div>
                    </div>
                </div>

                <!-- Acciones -->
                <AuthorizeView Roles="Admin,Agent">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white border-bottom py-3 px-4">
                            <h6 class="mb-0 fw-semibold text-slate-800">Acciones</h6>
                        </div>
                        <div class="card-body p-4 d-grid gap-2">
                            @if (!_ticket.AssignedToId.HasValue || _ticket.AssignedToId.Value != _currentUserId)
                            {
                                <button class="btn btn-outline-emerald" @onclick="ShowAssignModal">
                                    <i class="bi bi-person-check me-2"></i> Asignarme este ticket
                                </button>
                            }

                            <button class="btn btn-outline-slate" @onclick="ShowUpdateModal">
                                <i class="bi bi-pencil me-2"></i> Editar Ticket
                            </button>

                            @if (_ticket.Status != TicketStatus.Closed && _ticket.Status != TicketStatus.Resolved)
                            {
                                <button class="btn btn-emerald" @onclick="ShowCloseModal">
                                    <i class="bi bi-check-circle me-2"></i> Cerrar Ticket
                                </button>
                            }
                        </div>
                    </div>
                </AuthorizeView>
            </div>
        </div>

        <!-- Modal para Asignar -->
        @if (_showAssignModal)
        {
            <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(15,23,42,0.5);">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg rounded-4">
                        <div class="modal-header border-0 pb-0">
                            <h5 class="modal-title fw-semibold text-slate-800">Asignar Ticket</h5>
                            <button type="button" class="btn-close" @onclick="() => _showAssignModal = false"></button>
                        </div>
                        <div class="modal-body text-slate-600">
                            <p>¿Deseas asignarte este ticket?</p>
                        </div>
                        <div class="modal-footer border-0 pt-0">
                            <button type="button" class="btn btn-outline-slate" @onclick="() => _showAssignModal = false">Cancelar</button>
                            <button type="button" class="btn btn-emerald" @onclick="HandleAssignTicket" disabled="@_isProcessing">
                                @if (_isProcessing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Asignar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Modal para Cerrar -->
        @if (_showCloseModal)
        {
            <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(15,23,42,0.5);">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg rounded-4">
                        <div class="modal-header border-0 pb-0">
                            <h5 class="modal-title fw-semibold text-slate-800">Cerrar Ticket</h5>
                            <button type="button" class="btn-close" @onclick="() => _showCloseModal = false"></button>
                        </div>
                        <div class="modal-body text-slate-600">
                            <p>¿Estás seguro que deseas cerrar este ticket?</p>
                        </div>
                        <div class="modal-footer border-0 pt-0">
                            <button type="button" class="btn btn-outline-slate" @onclick="() => _showCloseModal = false">Cancelar</button>
                            <button type="button" class="btn btn-emerald" @onclick="HandleCloseTicket" disabled="@_isProcessing">
                                @if (_isProcessing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Cerrar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Modal para Eliminar -->
        @if (_showDeleteModal)
        {
            <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(15,23,42,0.5);">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg rounded-4">
                        <div class="modal-header bg-danger text-white border-0 rounded-top-4">
                            <h5 class="modal-title fw-semibold">Eliminar Ticket</h5>
                            <button type="button" class="btn-close btn-close-white" @onclick="() => _showDeleteModal = false"></button>
                        </div>
                        <div class="modal-body text-slate-600">
                            <p><strong class="text-danger">¡Advertencia!</strong> Esta acción no se puede deshacer.</p>
                            <p class="mb-0">¿Estás seguro que deseas eliminar este ticket?</p>
                        </div>
                        <div class="modal-footer border-0 pt-0">
                            <button type="button" class="btn btn-outline-slate" @onclick="() => _showDeleteModal = false">Cancelar</button>
                            <button type="button" class="btn btn-danger" @onclick="HandleDeleteTicket" disabled="@_isProcessing">
                                @if (_isProcessing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Modal para Actualizar -->
        @if (_showUpdateModal)
        {
            <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(15,23,42,0.5);">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg rounded-4">
                        <div class="modal-header border-0 pb-0">
                            <h5 class="modal-title fw-semibold text-slate-800">Editar Ticket</h5>
                            <button type="button" class="btn-close" @onclick="() => _showUpdateModal = false"></button>
                        </div>
                        <EditForm Model="@_updateRequest" OnValidSubmit="@HandleUpdateTicket">
                            <DataAnnotationsValidator />
                            <div class="modal-body">
                                <div class="mb-4">
                                    <label class="form-label fw-medium text-slate-700">Título</label>
                                    <InputText class="form-control border-slate-200" @bind-Value="_updateRequest.Title" />
                                    <ValidationMessage For="@(() => _updateRequest.Title)" class="text-danger small mt-1" />
                                </div>
                                <div class="mb-4">
                                    <label class="form-label fw-medium text-slate-700">Descripción</label>
                                    <InputTextArea class="form-control border-slate-200" rows="5" @bind-Value="_updateRequest.Description" />
                                    <ValidationMessage For="@(() => _updateRequest.Description)" class="text-danger small mt-1" />
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-medium text-slate-700">Prioridad</label>
                                    <InputSelect class="form-select border-slate-200" @bind-Value="_updateRequest.Priority">
                                        <option value="Low">Baja</option>
                                        <option value="Medium">Media</option>
                                        <option value="High">Alta</option>
                                        <option value="Urgent">Urgente</option>
                                    </InputSelect>
                                    <ValidationMessage For="@(() => _updateRequest.Priority)" class="text-danger small mt-1" />
                                </div>
                            </div>
                            <div class="modal-footer border-0 pt-0">
                                <button type="button" class="btn btn-outline-slate" @onclick="() => _showUpdateModal = false">Cancelar</button>
                                <button type="submit" class="btn btn-emerald" disabled="@_isProcessing">
                                    @if (_isProcessing)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2"></span>
                                    }
                                    Guardar Cambios
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        }
    }
</div>

@code {
    [Parameter]
    public int Id { get; set; }

    private TicketDetailsDto? _ticket;
    private AddCommentRequest _commentRequest = new();
    private UpdateTicketRequest _updateRequest = new();

    private bool _isLoading = true;
    private bool _isSubmittingComment = false;
    private bool _isProcessing = false;
    private string? _errorMessage;
    private string? _successMessage;

    private bool _showAssignModal = false;
    private bool _showCloseModal = false;
    private bool _showDeleteModal = false;
    private bool _showUpdateModal = false;

    private int _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        await GetCurrentUserId();
        await LoadTicket();
    }

    private async Task GetCurrentUserId()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userIdClaim = authState.User.Claims.FirstOrDefault(c => c.Type == "sub");
        if (userIdClaim != null && int.TryParse(userIdClaim.Value, out var userId))
        {
            _currentUserId = userId;
        }
    }

    private async Task LoadTicket()
    {
        try
        {
            _isLoading = true;
            _errorMessage = null;
            _ticket = await TicketApiClient.GetTicketByIdAsync(Id);
            _commentRequest.TicketId = Id;

            if (_ticket != null)
            {
                _updateRequest.TicketId = _ticket.Id;
                _updateRequest.Title = _ticket.Title;
                _updateRequest.Description = _ticket.Description;
                _updateRequest.Priority = _ticket.Priority.ToString();
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al cargar el ticket: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task HandleAddComment()
    {
        try
        {
            _isSubmittingComment = true;
            await TicketApiClient.AddCommentAsync(Id, _commentRequest);
            _commentRequest.Content = "";
            _successMessage = "Comentario agregado correctamente.";
            await LoadTicket();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error al agregar comentario: {ex.Message}";
        }
        finally
        {
            _isSubmittingComment = false;
        }
    }

    private void ShowAssignModal() => _showAssignModal = true;
    private void ShowCloseModal() => _showCloseModal = true;
    private void ShowDeleteModal() => _showDeleteModal = true;
    private void ShowUpdateModal() => _showUpdateModal = true;

    private async Task HandleAssignTicket()
    {
        try
        {
            _isProcessing = true;
            await TicketApiClient.AssignTicketAsync(Id, _currentUserId);
            _showAssignModal = false;
            _successMessage = "Ticket asignado correctamente.";
            await LoadTicket();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private async Task HandleCloseTicket()
    {
        try
        {
            _isProcessing = true;
            await TicketApiClient.CloseTicketAsync(Id);
            _showCloseModal = false;
            _successMessage = "Ticket cerrado correctamente.";
            await LoadTicket();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private async Task HandleDeleteTicket()
    {
        try
        {
            _isProcessing = true;
            await TicketApiClient.DeleteTicketAsync(Id);
            Navigation.NavigateTo("/tickets");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
            _showDeleteModal = false;
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private async Task HandleUpdateTicket()
    {
        try
        {
            _isProcessing = true;
            await TicketApiClient.UpdateTicketAsync(Id, _updateRequest);
            _showUpdateModal = false;
            _successMessage = "Ticket actualizado correctamente.";
            await LoadTicket();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            _isProcessing = false;
        }
    }

    private string GetStatusBadgeClass(TicketStatus status) => status switch
    {
        TicketStatus.Open => "badge-open",
        TicketStatus.InProgress => "badge-in-progress",
        TicketStatus.Closed => "badge-closed",
        TicketStatus.Resolved => "badge-resolved",
        _ => "bg-secondary"
    };

    private string GetStatusLabel(TicketStatus status) => status switch
    {
        TicketStatus.Open => "Abierto",
        TicketStatus.InProgress => "En Progreso",
        TicketStatus.Closed => "Cerrado",
        TicketStatus.Resolved => "Resuelto",
        _ => status.ToString()
    };

    private string GetPriorityBadgeClass(TicketPriority priority) => priority switch
    {
        TicketPriority.Low => "badge-low",
        TicketPriority.Medium => "badge-medium",
        TicketPriority.High => "badge-high",
        TicketPriority.Critical => "badge-urgent",
        _ => "bg-secondary"
    };

    private string GetPriorityLabel(TicketPriority priority) => priority switch
    {
        TicketPriority.Low => "Baja",
        TicketPriority.Medium => "Media",
        TicketPriority.High => "Alta",
        TicketPriority.Critical => "Urgente",
        _ => priority.ToString()
    };
}